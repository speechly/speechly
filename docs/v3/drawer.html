<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset='utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1'>

	<title>Speechly Web Toolkit and Browser-UI Beta</title>

  <link rel='icon' type='image/png' href='favicon.png'>
	<link rel='stylesheet' href='global.css'>
  <link rel="stylesheet" href="v3/speechly-ui.css">
 
  <!-- <script src="https://unpkg.com/@webcomponents/custom-elements"></script> -->
	<script src='v3/push-to-talk-button.js'></script>
	<script src='v3/transcript-drawer.js'></script>
</head>

<body>

  <transcript-drawer hint='["Try: Show me blue jeans", "Try: 2nd hint", "Try: 3rd hint"]' backgroundcolor="#f8f8f8" color="#333" smalltextcolor="#0006" highlightcolor="#15d8a5" gradientstop1="#0005" gradientstop2="#0008"></transcript-drawer>

  <div class="PushToTalkContainer">
    <push-to-talk-button></push-to-talk-button>
  </div>

  <main>
    <h1>Transcript Drawer for Web Toolkit</h1>
    <h2>Quick installation from CDN</h2>
      Include the resources in your <code>&lt;head&gt;</code> block:
<xmp><head>
  <script type="text/javascript" src="https://speechly.github.io/browser-ui/v3/push-to-talk-button.js"></script>
  <script type="text/javascript" src="https://speechly.github.io/browser-ui/v3/transcript-drawer.js"></script>
  <link rel="stylesheet" href="https://speechly.github.io/browser-ui/v3/speechly-ui.css">
</head>
</xmp>

    <h2>Usage</h2>
      <p>
        Include the following lines in your <code>&lt;body&gt;</code>:
      </p>
<xmp><transcript-drawer></transcript-drawer> 
</xmp>

<xmp><div class="PushToTalkContainer">
  <push-to-talk-button appid="ead4b9e7-e5c4-48ed-9dae-3c530916ed76"></push-to-talk-button>
</div>
</xmp>

    <h2>Handling Speech Input</h2>
    Listen for the broadcasted speechsegment messages:
<xmp><script type="text/javascript">
  window.addEventListener("message", (e) => {
    if (e.data.type === "speechsegment") {
      const segment = e.data.segment;
      console.log("speechsegment message:", segment);
    }
  });
</script>
</xmp>
    
    <h2>Element &lt;transcript-drawer/&gt;</h2>
    <p>
      <code>&lt;transcript-drawer/&gt;</code> is an drawer-style component for displaying real-time speech-to-text transcript and hint texts.
    </p>
    <p>
      It's an alternative to big-transcript (actually a wrapper). It is displayed at the top of the screen. It is momentarily displayed and automatically hidden after the end of voice input.
    </p>
    <button onclick="showTranscriptSample()">Show sample transcript</button>

    <h3>Attributes</h3>
    <ul>
      <li><code>hint</code> - Hint text to be shown when the app is listening for speech. Hint is hidden upon user speech is received. String or a JSON.stringify'ed string array, e.g. <code>hint='["Try: 1st hint", "Try: 2nd hint"]'</code>. Pay attention to use double quotes in JSON. If an array is provided, the next tip is automatically shown after an utterance. After all tips are shown, they will be shown again in random order. Default: ""</li>
      <li><code>height</code> - Optional minimum height as CSS string. Default: "8rem"</li>
      <li><code>color</code> - Optional string (CSS color) for text. Default: "#ffffff"
      <li><code>smalltextcolor</code> - Optional string (CSS color) for hint text. Default: "#ffffff70"
      <li><code>highlightcolor</code> - Optional string (CSS color) for entity highlighting, vu meter and acknowledged icon. Default: "#15e8b5"
      <li><code>backgroundcolor</code> - Optional string (CSS color) for hint text background. Default: "#202020"
      <li><code>fontsize</code> - Optional CSS string for text size. Default: "1.5rem"</li>
      <li><code>hintfontsize</code> - Optional CSS string for hint text size. Default: "0.9rem"</li>
      <li><code>formattext</code> - Optional "true" | "false". If true, transcript is formatted with detected entities, e.g. numbers. Default: "true"
    </ul>

    <h3>Properties</h3>
    <ul>
      <li><code>speechsegment(segment: Segment)</code> - Function. Call whenever a new segment update is available</li>
      <li><code>speechstate(state: ClientState)</code> - Function. Call whenever ClientState changes. Needed to show/hide element.</li>
      <li><code>speechhandled(success: boolean)</code> - Function. Optionally call on segment.isFinal to show confirmation that speech was processed. An indication will be shown with big-transcript.</li>
      <li><code>sethint(message: string)</code> - Optionally update hint text.</li>
    </ul>

    <h3>Window messages listened</h3>
    <ul>
      <li><code>{type: "speechsegment", segment: Segment}</code> - Expects an update whenever a new segment update is available</li>
      <li><code>{type: "speechstate", state: ClientState}</code> - Needed to show/hide element</li>
      <li><code>{type: "speechhandled", success: boolean}</code> - Optionally send a confirmation on segment.isFinal that speech was processed. An indication will be shown with big-transcript.</li>
      <li><code>{type: "hint", hint: text}</code> - Optionally update hint text.</li>
    </ul>


    <h2>Browser-UI Playground Log</h2>
    <p>
      Try it out! Hold the button and talk.
      You can also try holding the hot key (SPACE) to activate listening.
    </p>
    <p>
      The listening hot key is disabled if an element like input has focus:<br/>
      <input type="text"/>
    </p>
    <pre><xmp id="info"></xmp></pre>
  </main>

	<script type="text/javascript">
    var webLogLines = "";
    webLog = (newLine) => {
      webLogLines += newLine + "\n";
      document.getElementById("info").innerHTML = webLogLines;
    }
    webLog("Start of index.html script V11...");
		const pushToTalkEl = document.getElementsByTagName("push-to-talk-button")[0];
    webLog("push-to-talk-button: "+pushToTalkEl);
		const transcriptDrawer = document.getElementsByTagName("transcript-drawer")[0];
    webLog("transcript-drawer: "+transcriptDrawer);

    // Use query param to override appid
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const appid = urlParams.get('appid') || urlParams.get('appId') || "ead4b9e7-e5c4-48ed-9dae-3c530916ed76";
    pushToTalkEl.setAttribute("appid", appid);

		pushToTalkEl.addEventListener("holdstart", (e) => {
      console.log("holdstart event received");
    });
		pushToTalkEl.addEventListener("holdend", (e) => {console.log("holdend event received", e.detail.timeMs)});

    window.addEventListener("message", (e) => {
      if (e.data.type === "speechsegment") {
        const segment = e.data.segment;
        console.log("speechsegment message:", segment);
        webLog(segment.words.map(w => w.value).join(" "));
        // transcriptEl.dispatchEvent(new CustomEvent("speechsegment", {detail: e.detail}));
        // window.postMessage({type: "speechsegment", segment: e.detail}, "*");
        if (segment.isFinal) {
          // Acknowledge we understood what was being said
          window.postMessage({type: "speechhandled", success: true}, "*");
        }
      }
    });

		pushToTalkEl.addEventListener("speechsegment", (e) => {
      const segment = e.detail;
      console.log("speechsegment event:", segment);
      // webLog(segment.words.map(w => w.value).join(" "));
      // transcriptEl.dispatchEvent(new CustomEvent("speechsegment", {detail: e.detail}));
      // window.postMessage({type: "speechsegment", segment: e.detail}, "*");
    });

		pushToTalkEl.addEventListener("starting", (e) => {
      webLog(`starting message received: ${e.detail}`)
      console.log(`starting message received: `, e.detail)
    });
		pushToTalkEl.addEventListener("initialized", (e) => {
      webLog(`initialized message received: ${e.detail}`)
      console.log(`initialized message received: `,e.detail)
    });

    const showTranscriptSample = (e) => {
      const sampleSegment = {
        "id": 0,
        "contextId": "e310e11e-95d4-4f22-98dd-388a1bd84718",
        "isFinal": false,
        "words": [
            {
                "value": "TURN",
                "index": 2,
                "startTimestamp": 2040,
                "endTimestamp": 2640,
                "isFinal": true
            },
            {
                "value": "ON",
                "index": 3,
                "startTimestamp": 2640,
                "endTimestamp": 2820,
                "isFinal": true
            },
            {
                "value": "THE",
                "index": 4,
                "startTimestamp": 2820,
                "endTimestamp": 2940,
                "isFinal": true
            },
            {
                "value": "LIGHTS",
                "index": 5,
                "startTimestamp": 2940,
                "endTimestamp": 3420,
                "isFinal": true
            },
            {
                "value": "YADDA",
                "index": 6,
                "startTimestamp": 2940,
                "endTimestamp": 3420,
                "isFinal": true
            },
            {
                "value": "YADDA",
                "index": 7,
                "startTimestamp": 2940,
                "endTimestamp": 3420,
                "isFinal": true
            },
            {
                "value": "YADDA",
                "index": 8,
                "startTimestamp": 2940,
                "endTimestamp": 3420,
                "isFinal": true
            },
            {
                "value": "YADDA",
                "index": 9,
                "startTimestamp": 2940,
                "endTimestamp": 3420,
                "isFinal": true
            },
            {
                "value": "YADDA",
                "index": 10,
                "startTimestamp": 2940,
                "endTimestamp": 3420,
                "isFinal": true
            }
        ],
        "entities": [
            {
                "type": "email",
                "value": "the lights",
                "startPosition": 4,
                "endPosition": 6,
                "isFinal": true
            }
        ],
        "intent": {
            "intent": "email",
            "isFinal": true
        }
      }

      window.postMessage({type: "speechsegment", segment: sampleSegment}, "*");
    }

    const hideButton = (e) => {
      pushToTalkEl.setAttribute("hide", "true");
    }

    const showButton = (e) => {
      pushToTalkEl.setAttribute("hide", "false");
    }

    webLog("End of index.html script");
	</script>
</body>
</html>
